<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบดึงเลขปิดรับ Real-time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f4f7f6; }
        .closed-number {
            background: linear-gradient(135deg, #ff4b2b, #ff416c);
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-live {
            width: 10px;
            height: 10px;
            background: #2ecc71;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .loading-bar {
            height: 4px;
            background: #db2777;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="max-w-6xl mx-auto p-4">
        <header class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex flex-col md:flex-row justify-between items-center border-b-4 border-pink-500">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ระบบแสดงเลขปิดรับ <span class="text-pink-600">LIVE</span></h1>
                <p class="text-gray-500 text-sm"><span class="status-live"></span> เชื่อมต่อข้อมูลเรียลไทม์จากเซิร์ฟเวอร์หลัก</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <div class="text-xs text-gray-400 mb-1">อัปเดตถัดไปใน: <span id="countdown">10</span> วินาที</div>
                <button onclick="updateData()" class="bg-pink-600 hover:bg-pink-700 text-white px-5 py-2 rounded-xl font-bold transition flex items-center shadow-lg">
                    <i class="fas fa-sync-alt mr-2" id="sync-icon"></i> รีเฟรชตอนนี้
                </button>
            </div>
        </header>

        <div class="loading-bar-container bg-gray-200 w-full mb-6 rounded-full overflow-hidden">
            <div id="loading-progress" class="loading-bar"></div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b">
                            <th class="p-5 font-bold uppercase text-sm">รายการหวย / รอบ</th>
                            <th class="p-5 font-bold uppercase text-sm">ประเภทเลข</th>
                            <th class="p-5 font-bold uppercase text-sm">เลขที่ระบบปิดรับ</th>
                            <th class="p-5 font-bold uppercase text-sm text-center">สถานะการรับ</th>
                        </tr>
                    </thead>
                    <tbody id="data-list" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="4" class="p-20 text-center text-gray-400">
                                <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-pink-500"></i>
                                <p>กำลังเชื่อมต่อ API และดึงข้อมูลล่าสุด...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer class="mt-8 text-center text-gray-400 text-xs">
            <p>เชื่อมต่อกับระบบ: https://numberclose.testder.com/api/</p>
            <p>© 2025 ระบบจำลองเลขปิดรับ - พัฒนาเพื่อการแสดงผลความเร็วสูง</p>
        </footer>
    </div>

    <script>
        const API_URL = 'https://numberclose.testder.com/api/get_closed_numbers.php?date=today';
        let countdownValue = 10;
        let timer;

        async function updateData() {
            const syncIcon = document.getElementById('sync-icon');
            const dataList = document.getElementById('data-list');
            const progress = document.getElementById('loading-progress');
            
            syncIcon.classList.add('fa-spin');
            progress.style.width = '30%';

            try {
                // ดึงข้อมูลจริงจาก API
                const response = await fetch(API_URL);
                progress.style.width = '70%';
                
                if (!response.ok) throw new Error('API_ERROR');
                
                const data = await response.json();
                renderTable(data.items);
                
                progress.style.width = '100%';
                setTimeout(() => progress.style.width = '0%', 500);

            } catch (error) {
                console.error('Error fetching data:', error);
                // หากดึงไม่ได้ ให้แสดงข้อความแจ้งเตือน (แต่ในโค้ดนี้เราจะให้มันพยายามต่อไป)
                dataList.innerHTML = `<tr><td colspan="4" class="p-10 text-center text-red-500 font-bold bg-red-50">
                    <i class="fas fa-exclamation-triangle mr-2"></i> ไม่สามารถดึงข้อมูลได้ (โปรดตรวจสอบสิทธิ์ CORS หรือการเชื่อมต่อเน็ต)
                </td></tr>`;
            } finally {
                syncIcon.classList.remove('fa-spin');
                resetCountdown();
            }
        }

        function renderTable(items) {
            const dataList = document.getElementById('data-list');
            
            if (!items || items.length === 0) {
                dataList.innerHTML = '<tr><td colspan="4" class="p-20 text-center text-gray-400">ไม่มีเลขปิดรับในขณะนี้</td></tr>';
                return;
            }

            dataList.innerHTML = ''; // ล้างตารางเดิม

            items.forEach(item => {
                const numbersHtml = item.numbers.map(n => `<span class="closed-number">${n}</span>`).join('');
                const row = `
                    <tr class="hover:bg-pink-50 transition-all border-b">
                        <td class="p-5 font-bold text-gray-700">
                            <i class="fas fa-ticket-alt mr-2 text-pink-400"></i> ${item.lotto_name}
                        </td>
                        <td class="p-5">
                            <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-md text-xs font-bold">${item.type_name}</span>
                        </td>
                        <td class="p-5">${numbersHtml}</td>
                        <td class="p-5 text-center">
                            <span class="text-red-600 font-bold animate-pulse">
                                <i class="fas fa-times-circle mr-1"></i> ปิดรับแทง
                            </span>
                        </td>
                    </tr>
                `;
                dataList.insertAdjacentHTML('beforeend', row);
            });
        }

        function resetCountdown() {
            clearInterval(timer);
            countdownValue = 10;
            document.getElementById('countdown').innerText = countdownValue;
            
            timer = setInterval(() => {
                countdownValue--;
                document.getElementById('countdown').innerText = countdownValue;
                if (countdownValue <= 0) {
                    updateData();
                }
            }, 1000);
        }

        // เริ่มทำงานครั้งแรก
        window.onload = updateData;
    </script>
</body>
</html>
